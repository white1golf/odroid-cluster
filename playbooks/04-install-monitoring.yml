---
# Phase 3: Monitoring Stack via Helm (kube-prometheus-stack)
# Prometheus + Grafana + AlertManager + node-exporter 한 번에 설치

- name: Install Monitoring Stack with Helm
  hosts: k3s_master
  become: yes
  gather_facts: yes

  tasks:
    # 1. Helm CLI 설치
    - name: Check if Helm is installed
      command: helm version --short
      register: helm_check
      ignore_errors: yes
      changed_when: false

    - name: Install Helm
      shell: curl -sfL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: helm_check.rc != 0

    # 2. Helm repo 추가
    - name: Add prometheus-community Helm repo
      shell: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      register: repo_add
      changed_when: "'has been added' in repo_add.stdout"
      failed_when: false

    - name: Update Helm repos
      shell: helm repo update
      changed_when: false

    # 3. monitoring namespace 생성
    - name: Create monitoring namespace
      shell: k3s kubectl create namespace monitoring --dry-run=client -o yaml | k3s kubectl apply -f -
      changed_when: false

    # 4. values 파일 생성 (ODROID N2+ 최적화)
    - name: Create Helm values file
      copy:
        dest: /tmp/monitoring-values.yml
        content: |
          # Prometheus 설정
          prometheus:
            prometheusSpec:
              retention: 7d
              retentionSize: "2GB"
              scrapeInterval: 30s
              resources:
                limits:
                  memory: 512Mi
                  cpu: 500m
                requests:
                  memory: 256Mi
                  cpu: 200m
              # master(control-plane) 노드에 배치
              nodeSelector:
                node-role.kubernetes.io/control-plane: "true"
              tolerations:
                - key: node-role.kubernetes.io/control-plane
                  effect: NoSchedule
                - key: node-role.kubernetes.io/master
                  effect: NoSchedule
            service:
              type: NodePort
              nodePort: 30090

          # Grafana 설정
          grafana:
            adminUser: admin
            adminPassword: odroid
            resources:
              limits:
                memory: 256Mi
                cpu: 300m
              requests:
                memory: 128Mi
                cpu: 100m
            nodeSelector:
              node-role.kubernetes.io/control-plane: "true"
            tolerations:
              - key: node-role.kubernetes.io/control-plane
                effect: NoSchedule
              - key: node-role.kubernetes.io/master
                effect: NoSchedule
            service:
              type: NodePort
              nodePort: 30030

          # AlertManager 설정
          alertmanager:
            alertmanagerSpec:
              resources:
                limits:
                  memory: 128Mi
                  cpu: 100m
                requests:
                  memory: 64Mi
                  cpu: 50m
              nodeSelector:
                node-role.kubernetes.io/control-plane: "true"
              tolerations:
                - key: node-role.kubernetes.io/control-plane
                  effect: NoSchedule
                - key: node-role.kubernetes.io/master
                  effect: NoSchedule
            service:
              type: NodePort
              nodePort: 30093

          # node-exporter (모든 노드에 DaemonSet)
          nodeExporter:
            resources:
              limits:
                memory: 64Mi
                cpu: 100m
              requests:
                memory: 32Mi
                cpu: 50m

          # kube-state-metrics
          kubeStateMetrics:
            resources:
              limits:
                memory: 128Mi
                cpu: 100m
              requests:
                memory: 64Mi
                cpu: 50m

    # 5. Helm으로 설치
    - name: Install kube-prometheus-stack
      shell: |
        helm upgrade --install monitoring \
          prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --values /tmp/monitoring-values.yml \
          --kubeconfig /etc/rancher/k3s/k3s.yaml \
          --wait --timeout 10m
      register: helm_install
      retries: 2
      delay: 30
      until: helm_install.rc == 0

    - name: Display Helm install result
      debug:
        msg: "{{ helm_install.stdout_lines[-5:] }}"

    # 6. 배포 상태 확인
    - name: Wait for pods to be ready
      shell: k3s kubectl wait --for=condition=ready pod -l "release=monitoring" -n monitoring --timeout=120s
      register: pods_ready
      ignore_errors: yes

    - name: Get monitoring pods status
      shell: k3s kubectl get pods -n monitoring -o wide
      register: monitoring_pods
      changed_when: false

    - name: Display monitoring status
      debug:
        msg: |
          === Monitoring Stack (Helm) ===
          {{ monitoring_pods.stdout }}

          === Access URLs ===
          Prometheus:    http://192.168.1.241:30090
          Grafana:       http://192.168.1.241:30030  (admin / odroid)
          AlertManager:  http://192.168.1.241:30093

          === Helm 관리 명령어 ===
          상태 확인: helm list -n monitoring
          업그레이드: helm upgrade monitoring prometheus-community/kube-prometheus-stack -n monitoring --values /tmp/monitoring-values.yml
          삭제:      helm uninstall monitoring -n monitoring
